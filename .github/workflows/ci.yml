name: CI & GitOps Strategy

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Seguran√ßa: limita permiss√µes padr√£o

    steps:
    # 1. Baixa o c√≥digo da API
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. Login no Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 3. Define a tag baseada no SHA curto do commit
    - name: Set Short SHA
      id: vars
      run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    # 4. Build e Push da Imagem Docker
    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/task-api:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/task-api:${{ steps.vars.outputs.sha_short }}

    # 5. Atualiza o Reposit√≥rio de Manifestos (GitOps)
    - name: Update Manifest Repository
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        MANIFEST_REPO: pdro1812/task-api-manifests 
        IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/task-api
        NEW_TAG: ${{ steps.vars.outputs.sha_short }}
      run: |
        echo "üöÄ Iniciando atualiza√ß√£o de manifesto para: $NEW_TAG"
        
        # Clona o repo
        git clone https://$GH_PAT@github.com/$MANIFEST_REPO.git deployment-repo
        cd deployment-repo
        
        # Configura git user
        git config user.name "GitHub Actions CI"
        git config user.email "actions@github.com"
        
        # Debug: Mostra como estava antes (bom para evid√™ncia no artigo)
        echo "üìÑ Vers√£o anterior:"
        grep "image:" 3-api.yaml
        
        # Atualiza a tag (Regex ajustado para pegar espa√ßos em branco antes de 'image:')
        sed -i "s|image: .*$IMAGE_NAME:.*|image: $IMAGE_NAME:$NEW_TAG|g" 3-api.yaml
        
        # Verifica mudan√ßa
        if [[ -n $(git status -s) ]]; then
          echo "üìÑ Nova vers√£o:"
          grep "image:" 3-api.yaml
          
          git add 3-api.yaml
          git commit -m "k8s(ci): update image tag to $NEW_TAG"
          git push origin main
          echo "‚úÖ Manifesto atualizado e push realizado!"
        else
          echo "‚ö†Ô∏è Nenhuma altera√ß√£o necess√°ria."
        fi